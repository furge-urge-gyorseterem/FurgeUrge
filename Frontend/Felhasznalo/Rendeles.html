<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rendelésem</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="rendeles.css">
</head>

<body>
    <main>
        <header>
            <img src="../kepek/Logo.png" alt="Logo">
            <h1>Rendelésed</h1>
            <img class="kep1" src="../kepek/Logo.png" alt="Logo">
        </header>
        <navigation>
            <ul class="navigation-left">

                <li><a href="Főoldal.html">Főoldal</a></li>
                <li><a href="kaja.html">Étlap</a></li>
                <li><a href="Rendeles.html">Rendelésem</a></li>
            </ul>
            <ul class="navigation-right">

                <li class="Profil"><a href="Profil.html">Profil</a></li>
                <li id="logout" class="Kilepes"><a href="">Kijelentkezés</a></li>

            </ul>
        </navigation>

        <article>
            <div class="order-status-container">
                <h2>Rendelés Státusza</h2>
                <div id="ordersStatus">
                    <!-- Order status content will be dynamically inserted here -->
                </div>
            </div>
            <div class="order-items-container">
                <h2>Megrendelt Tételek</h2>
                <div id="orderItems">

                </div>
            </div>
        </article>

    </main>
    <script>
        $(document).ready(function () {
            redirectIfUnauthenticated()
            const id = localStorage.getItem('userid');
            fetchOrderItems(id);
            function fetchOrderItems(userid) {
                $.ajax({
                    url: `http://localhost:3000/api/undelivered-orders/${userid}`, // Adjust this URL to your API endpoint
                    type: 'GET',
                    success: function (orders) {
                        // Check if there are any orders
                        if (orders.length > 0) {
                            let orderItemsHtml = '';
                            orders.forEach(function (order) {
                                // Add each food item with quantity to the list
                                order['Ételek'].forEach(function (item) {
                                    orderItemsHtml += '<p>' + item['Étel Neve'] + ' - Mennyiség: ' + item['Mennyiség'] + '</p>';
                                });
                            });
                            $('#orderItems').html(orderItemsHtml); // Insert the items into the container
                        } else {
                            $('#orderItems').html('<p>Nincsenek nyitott rendelések.</p>');
                        }
                    },
                    error: function () {
                        $('#orderItems').html('<p>Hiba történt a megrendelt tételek lekérdezésekor.</p>');
                    }
                });
            }
            $.ajax({
                url: 'http://localhost:3000/api/orders/status/' + id,
                type: 'GET',
                success: function (response) {
                    console.log(response)
                    if (response.length > 0) {
                        var ordersList = '';
                        response.forEach(function (order) {
                            ordersList += '<p>' + order.Státusz + '</p>';
                        });
                        $('#ordersStatus').html(ordersList);
                    } else {
                        $('#ordersStatus').html('Nincsenek nyitott rendelések.');
                    }
                },
                error: function () {
                    $('#ordersStatus').html('Hiba történt a rendelés státuszainak lekérdezésekor.');
                }
            });
            $(document).on("click", ".Kilepes", (event) => {

                event.preventDefault();
                $.ajax({
                    url: 'http://localhost:3000/api/logout', // Adjust URL to match API route
                    type: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('accessToken'), // accessToken should be the token you received during login
                    },
                    success: function (response) {
                        console.log('Logout successful');
                        localStorage.clear()
                        window.location.href = '../Guest/FőoldalGuest.html';
                    },
                    error: function (xhr, status, error) {
                        console.error('Logout failed:', error);
                    }
                });
            });
        });
        const státusz = localStorage.getItem('statusz')
        const adminLi = státusz === 'Admin' ? $('<li><a href="http://localhost:3001/">Admin</a></li>') : $();

        $('navigation ul.navigation-right').prepend(adminLi);
        function redirectIfUnauthenticated() {
            if (!localStorage.getItem('accessToken')) {
                window.location.href = '../Guest/FőoldalGuest.html'; // Átirányítás a nem bejelentkezett felhasználók főoldalára
            }

        }

    </script>

</body>

</html>